generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Product {
  uid                Int              @id @default(autoincrement())
  name               String
  sku                String           @unique
  categories         String[] // Array of categories
  basePrice          Decimal
  discountedPrice    Decimal?
  discountPercentage Int?
  soldCount          Int              @default(0)
  image              String?
  description        String?
  uploaded           DateTime         @default(now())
  updated            DateTime         @updatedAt
  variants           ProductVariant[]
  cartItems          CartItem[] // Ensure 1-to-many relation is compatible

  // Seller Relation
  sellerId Int?
  seller   Seller? @relation(fields: [sellerId], references: [uid])

  // OrderItems
  orderItems OrderItem[]
}

model ProductVariant {
  uid                Int        @id @default(autoincrement())
  product            Product    @relation(fields: [productId], references: [uid], onDelete: Cascade)
  productId          Int
  name               String // "Small Red", "Large Blue", or "Default"
  sku                String     @unique
  stock              Int        @default(0)
  soldCount          Int        @default(0)
  price              Decimal? // Optional variant-specific price override
  discountPercentage Int? // Variant-specific discount
  discountedPrice    Decimal? // Variant-specific discounted price
  image              String? // Optional variant-specific image
  cartItems          CartItem[]

  @@unique([productId, name])
}

model Customer {
  uid                   Int               @id @default(autoincrement())
  name                  String
  email                 String            @unique
  password              String
  phone                 String?
  address               String?
  uploaded              DateTime          @default(now())
  updated               DateTime          @updatedAt
  orders                Order[]
  cart                  Cart? // One-to-one relation with Cart
  role                  Role              @default(USER)
  passwordResetRequired Boolean           @default(false)
  sellerProfile         Seller?           @relation("CustomerSeller")
  checkoutSessions      CheckoutSession[]
}

model Cart {
  uid        Int        @id @default(autoincrement())
  customer   Customer   @relation(fields: [customerId], references: [uid])
  customerId Int        @unique // Ensure 1-to-1
  items      CartItem[]
  updated    DateTime   @updatedAt
}

model CartItem {
  uid              Int             @id @default(autoincrement())
  cart             Cart            @relation(fields: [cartId], references: [uid])
  cartId           Int
  product          Product         @relation(fields: [productId], references: [uid])
  productId        Int
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [uid])
  productVariantId Int?
  quantity         Int             @default(1)
}

model Order {
  uid            Int         @id @default(autoincrement())
  customer       Customer    @relation(fields: [customerId], references: [uid])
  customerId     Int
  products       String
  items          OrderItem[]
  discount       Decimal?
  total          Decimal
  status         OrderStatus @default(PENDING)
  idempotencyKey String?     @unique
  uploaded       DateTime    @default(now())
  updated        DateTime    @updatedAt
  payments       Payment[]
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model CheckoutSession {
  uid            Int            @id @default(autoincrement())
  customerId     Int
  customer       Customer       @relation(fields: [customerId], references: [uid])
  cartSnapshot   String // JSON snapshot of cart at checkout start
  lockedPrices   String // JSON of locked prices
  totalAmount    Decimal
  status         CheckoutStatus @default(INITIATED)
  expiresAt      DateTime
  idempotencyKey String         @unique
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  payments       Payment[]
}

enum CheckoutStatus {
  INITIATED
  VALIDATING
  AWAITING_PAYMENT
  PROCESSING_PAYMENT
  COMPLETED
  EXPIRED
  CANCELLED
  FAILED
}

model Payment {
  uid               Int             @id @default(autoincrement())
  orderId           Int?
  order             Order?          @relation(fields: [orderId], references: [uid])
  checkoutSessionId Int
  checkoutSession   CheckoutSession @relation(fields: [checkoutSessionId], references: [uid])
  amount            Decimal
  method            String
  status            PaymentStatus   @default(PENDING)
  gatewayRef        String? // External payment gateway reference
  idempotencyKey    String          @unique
  errorMessage      String?
  attempts          Int             @default(1)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}

enum Role {
  USER
  SELLER
  ADMIN
}

enum SellerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BANNED
}

// New Models

model Seller {
  uid             Int          @id @default(autoincrement())
  name            String
  slug            String       @unique
  email           String       @unique
  phone           String?
  description     String?
  logo            String?
  banner          String?
  status          SellerStatus @default(PENDING) // pending, active, suspended, banned
  termsAccepted   Boolean      @default(false)
  termsAcceptedAt DateTime?
  commissionRate  Decimal      @default(0.15)
  totalSales      Decimal      @default(0)
  totalOrders     Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?
  products        Product[]
  orderItems      OrderItem[]

  customerId Int      @unique
  customer   Customer @relation("CustomerSeller", fields: [customerId], references: [uid], onDelete: Cascade)
}

model OrderItem {
  uid              Int       @id @default(autoincrement())
  orderId          Int
  order            Order     @relation(fields: [orderId], references: [uid])
  productId        Int
  product          Product   @relation(fields: [productId], references: [uid])
  sellerId         Int?
  seller           Seller?   @relation(fields: [sellerId], references: [uid])
  quantity         Int
  price            Decimal
  status           String    @default("pending_payment")
  trackingNumber   String?
  shippingProvider String?
  shippedAt        DateTime?
  deliveredAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}
