generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Product {
  uid                Int              @id @default(autoincrement())
  name               String
  sku                String           @unique
  categories         String[] // Array of categories
  basePrice          Decimal
  discountedPrice    Decimal?
  discountPercentage Int?
  image              String?
  description        String?
  uploaded           DateTime         @default(now())
  updated            DateTime         @updatedAt
  variants           ProductVariant[]
  cartItems          CartItem[]
}

model ProductVariant {
  uid                Int        @id @default(autoincrement())
  product            Product    @relation(fields: [productId], references: [uid], onDelete: Cascade)
  productId          Int
  name               String // "Small Red", "Large Blue", or "Default"
  sku                String     @unique
  stock              Int        @default(0)
  price              Decimal? // Optional variant-specific price override
  discountPercentage Int? // Variant-specific discount
  discountedPrice    Decimal? // Variant-specific discounted price
  image              String? // Optional variant-specific image
  cartItems          CartItem[]

  @@unique([productId, name])
}

model Customer {
  uid              Int               @id @default(autoincrement())
  name             String
  email            String            @unique
  password         String
  phone            String?
  address          String?
  uploaded         DateTime          @default(now())
  updated          DateTime          @updatedAt
  orders           Order[]
  cart             Cart? // One-to-one relation with Cart
  role             String            @default("USER")
  checkoutSessions CheckoutSession[]
}

model Cart {
  uid        Int        @id @default(autoincrement())
  customer   Customer   @relation(fields: [customerId], references: [uid])
  customerId Int        @unique // Ensure 1-to-1
  items      CartItem[]
  updated    DateTime   @updatedAt
}

model CartItem {
  uid              Int             @id @default(autoincrement())
  cart             Cart            @relation(fields: [cartId], references: [uid])
  cartId           Int
  product          Product         @relation(fields: [productId], references: [uid])
  productId        Int
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [uid])
  productVariantId Int?
  quantity         Int             @default(1)
}

model Order {
  uid            Int         @id @default(autoincrement())
  customer       Customer    @relation(fields: [customerId], references: [uid])
  customerId     Int
  products       String
  discount       Decimal?
  total          Decimal
  status         OrderStatus @default(PENDING)
  idempotencyKey String?     @unique
  uploaded       DateTime    @default(now())
  updated        DateTime    @updatedAt
  payments       Payment[]
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

model CheckoutSession {
  uid            Int            @id @default(autoincrement())
  customerId     Int
  customer       Customer       @relation(fields: [customerId], references: [uid])
  cartSnapshot   String // JSON snapshot of cart at checkout start
  lockedPrices   String // JSON of locked prices
  totalAmount    Decimal
  status         CheckoutStatus @default(INITIATED)
  expiresAt      DateTime
  idempotencyKey String         @unique
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  payments       Payment[]
}

enum CheckoutStatus {
  INITIATED
  VALIDATING
  AWAITING_PAYMENT
  PROCESSING_PAYMENT
  COMPLETED
  EXPIRED
  CANCELLED
  FAILED
}

model Payment {
  uid               Int             @id @default(autoincrement())
  orderId           Int?
  order             Order?          @relation(fields: [orderId], references: [uid])
  checkoutSessionId Int
  checkoutSession   CheckoutSession @relation(fields: [checkoutSessionId], references: [uid])
  amount            Decimal
  method            String
  status            PaymentStatus   @default(PENDING)
  gatewayRef        String? // External payment gateway reference
  idempotencyKey    String          @unique
  errorMessage      String?
  attempts          Int             @default(1)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  CANCELLED
}
